; myIoTGrid.NodeLoraWan - PlatformIO Configuration
; ================================================
; LoRaWAN Sensor Firmware für Heltec LoRa32 V3
; Basiert auf myIoTGrid.Sensor Architektur
;
; Version: 1.0.0
; Sprint: LoRa-02 - Grid.Sensor LoRaWAN Firmware
; Hackathon: 12./13. Dezember 2025

[platformio]
default_envs = native
src_dir = src
include_dir = include
lib_dir = lib
test_dir = test

; ============================================================
; COMMON SETTINGS
; ============================================================
[common]
firmware_version = 1.0.0
build_flags =
    -DFIRMWARE_VERSION=\"${common.firmware_version}\"
    -DCORE_DEBUG_LEVEL=0
    -std=gnu++17
build_unflags = -std=gnu++11

; ============================================================
; HELTEC LORA32 V3 - PRODUCTION
; ============================================================
; Echte Hardware mit echten Sensoren und LoRaWAN
[env:heltec_lora32_v3]
platform = espressif32
board = heltec_wifi_lora_32_V3
framework = arduino
monitor_speed = 115200
upload_speed = 921600
lib_ldf_mode = deep+

build_flags =
    ${common.build_flags}
    -DPLATFORM_ESP32
    -DTARGET_LORA32
    -DSIMULATE_SENSORS=0

    ; Include paths for cross-library includes
    -I include
    -I src

    ; LoRaWAN Band (EU868)
    -DLORA_BAND=868E6
    -DLORA_REGION_EU868

    ; Heltec LoRa32 V3 SX1262 Pin Definitions
    -DLORA_SCK=9
    -DLORA_MISO=11
    -DLORA_MOSI=10
    -DLORA_CS=8
    -DLORA_RST=12
    -DLORA_DIO1=14
    -DLORA_BUSY=13
    -DLORA_TCXO_VOLTAGE=1.8

    ; OLED Display (SSD1306 128x64)
    -DOLED_SDA=17
    -DOLED_SCL=18
    -DOLED_RST=21
    -DOLED_WIDTH=128
    -DOLED_HEIGHT=64
    -DOLED_ADDRESS=0x3C

    ; I2C für Sensoren (BME280, etc.)
    -DI2C_SDA=41
    -DI2C_SCL=42

    ; Battery Monitoring
    -DBATTERY_ADC_PIN=1
    -DBATTERY_DIVIDER_RATIO=4.9

    ; User Button & LED
    -DUSER_BUTTON_PIN=0
    -DLED_PIN=35

    ; Ultrasonic Sensor (Water Level)
    -DULTRASONIC_TRIG_PIN=5
    -DULTRASONIC_ECHO_PIN=4

lib_deps =
    ; JSON
    bblanchon/ArduinoJson@^7.2.1

    ; LoRaWAN Stack
    jgromes/RadioLib@^6.6.0

    ; OLED Display
    adafruit/Adafruit SSD1306@^2.5.10
    adafruit/Adafruit GFX Library@^1.11.9

    ; Sensors
    adafruit/Adafruit BME280 Library@^2.2.4
    adafruit/Adafruit Unified Sensor@^1.1.14
    adafruit/Adafruit BME680 Library@^2.0.4
    closedcube/ClosedCube SHT31D@^1.5.1
    milesburton/DallasTemperature@^3.11.0
    paulstoffregen/OneWire@^2.3.8
    adafruit/DHT sensor library@^1.4.6

    ; Native ESP32
    Wire
    SPI
    Preferences

    ; Local libraries (from lib/ folder)
    hal_lora32

lib_ignore =
    hal_native

; ============================================================
; HELTEC LORA32 V3 - SIMULATION
; ============================================================
; Echte Hardware mit simulierten Sensoren (für Tests ohne Hardware-Sensoren)
[env:heltec_lora32_v3_simulate]
extends = env:heltec_lora32_v3
build_flags =
    ${env:heltec_lora32_v3.build_flags}
    -DSIMULATE_SENSORS=1

; ============================================================
; NATIVE - LINUX/DOCKER SIMULATOR
; ============================================================
; Für lokale Entwicklung und Tests ohne Hardware
[env:native]
platform = native
build_flags =
    ${common.build_flags}
    -DPLATFORM_NATIVE
    -DSIMULATE_SENSORS=1
    -DSIMULATE_LORA=1
    -DLORA_BAND=868E6

lib_deps =
    bblanchon/ArduinoJson@^7.2.1

lib_ignore =
    hal_lora32
    Adafruit SSD1306
    Adafruit GFX Library
    Adafruit BME280 Library
    Adafruit Unified Sensor
    RadioLib

; ============================================================
; NATIVE TEST - UNIT TESTS
; ============================================================
[env:native_test]
extends = env:native
build_flags =
    ${env:native.build_flags}
    -DUNIT_TEST

lib_deps =
    ${env:native.lib_deps}
    throwtheswitch/Unity@^2.5.2

test_framework = unity
test_build_src = no

; ============================================================
; OPTIONAL: HELTEC LORA32 V2 (ältere Hardware)
; ============================================================
[env:heltec_lora32_v2]
platform = espressif32
board = heltec_wifi_lora_32
framework = arduino
monitor_speed = 115200

build_flags =
    ${common.build_flags}
    -DPLATFORM_ESP32
    -DTARGET_LORA32_V2
    -DSIMULATE_SENSORS=0
    -DLORA_BAND=868E6

    ; LoRa32 V2 verwendet SX1276 statt SX1262
    -DLORA_SCK=5
    -DLORA_MISO=19
    -DLORA_MOSI=27
    -DLORA_CS=18
    -DLORA_RST=14
    -DLORA_DIO0=26
    -DLORA_DIO1=35
    -DLORA_DIO2=34

    ; OLED Display
    -DOLED_SDA=4
    -DOLED_SCL=15
    -DOLED_RST=16

lib_deps =
    ${env:heltec_lora32_v3.lib_deps}

lib_ignore =
    hal_native
