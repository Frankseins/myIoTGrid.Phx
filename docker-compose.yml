# =============================================================================
# myIoTGrid - Complete Docker Stack
# =============================================================================
# Services:
# - hub-api:      Backend API (.NET 10) - Port 5000 (HTTP) + 5002 (Sensors)
# - hub-frontend: Frontend (Angular/nginx) - Port 443 (HTTPS)
# - sensor-sim:   Sensor Simulator (Native) - Test sensor with auto-discovery
#
# Note: Internal communication uses HTTP (secure within Docker network)
#       HTTPS is handled by nginx for external traffic
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API (.NET 10) - Port 5000 (HTTP) + 5002 (Sensors)
  # ---------------------------------------------------------------------------
  hub-api:
    build:
      context: .
      dockerfile: myIoTGrid.Hub/src/myIoTGrid.Hub.Api/Dockerfile
    image: ghcr.io/frankseins/myiotgrid-hub-phx-api:latest
    container_name: myIoTGrid.Hub
    restart: unless-stopped
    ports:
      - "5000:5000"
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:5000;http://+:5002
      - ConnectionStrings__HubDb=Data Source=/app/data/hub.db
      - Mqtt__Host=host.docker.internal
      - Mqtt__Port=1883
      - Hub__DefaultTenantName=Default
      - Discovery__Enabled=true
      - Discovery__Port=5000
      - Discovery__Protocol=http
      - Discovery__ApiPort=5000
    volumes:
      - hub-data:/app/data
      - hub-logs:/app/logs
    networks:
      - myiotgrid-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.myiotgrid.service=hub-api"
      - "com.myiotgrid.description=Backend API (HTTP)"

  # ---------------------------------------------------------------------------
  # Frontend (Angular + nginx with HTTPS) - Port 443
  # ---------------------------------------------------------------------------
  hub-frontend:
    build:
      context: ./myIoTGrid.Apps
      dockerfile: docker/Dockerfile.hub
    image: ghcr.io/frankseins/myiotgrid-hub-phx-frontend:latest
    container_name: myIoTGrid.Frontend
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    environment:
      # Internal Docker network uses HTTP (secure within network)
      # nginx handles HTTPS for external traffic
      - API_BACKEND_URL=http://hub-api:5000
    volumes:
      - ./certs:/etc/nginx/certs:ro
    networks:
      - myiotgrid-network
    depends_on:
      hub-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "--no-check-certificate", "https://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      - "com.myiotgrid.service=hub-frontend"
      - "com.myiotgrid.description=Frontend UI (HTTPS)"

  # ---------------------------------------------------------------------------
  # Sensor Simulator (Native Build) - Auto-discovers Hub via UDP broadcast
  # ---------------------------------------------------------------------------
  sensor-sim:
    build:
      context: ./myIoTGrid.Sensor
      dockerfile: docker/Dockerfile
    image: ghcr.io/frankseins/myiotgrid-phx-sensor-sim:latest
    container_name: myIoTGrid.Sensor
    restart: unless-stopped
    environment:
      # Manual fallback config (used if discovery fails)
      - HUB_HOST=hub-api
      - HUB_PORT=5002
      - HUB_PROTOCOL=http
      - HUB_INSECURE=false
      # Discovery configuration
      - DISCOVERY_ENABLED=true
      - DISCOVERY_PORT=5000
      - SENSOR_ID=sim-sensor-01
      - DATA_DIR=/data
    volumes:
      - sensor-data:/data
    networks:
      - myiotgrid-network
    depends_on:
      hub-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-x", "sensor"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.myiotgrid.service=sensor-sim"
      - "com.myiotgrid.description=Test Sensor Simulator"

# =============================================================================
# Networks
# =============================================================================
networks:
  myiotgrid-network:
    driver: bridge
    name: myiotgrid-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  hub-data:
    name: myiotgrid-hub-data
  hub-logs:
    name: myiotgrid-hub-logs
  sensor-data:
    name: myiotgrid-sensor-data
