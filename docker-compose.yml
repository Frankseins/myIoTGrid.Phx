# =============================================================================
# myIoTGrid - Complete Docker Stack
# =============================================================================
# Services:
# - hub-api:      Backend API (.NET 10) - Port 5001 (HTTPS + UDP Discovery)
# - hub-frontend: Frontend (Angular/nginx) - Port 443 (HTTPS)
# - sensor-sim:   Sensor Simulator (Native) - Test sensor with auto-discovery
#
# Note: MQTT Broker is provided by myIoTGrid.Gateway.LoRaWAN stack (Port 1883/1884)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API (.NET 10) - Port 5001 (HTTPS + UDP Discovery)
  # ---------------------------------------------------------------------------
  hub-api:
    build:
      context: .
      dockerfile: myIoTGrid.Hub/src/myIoTGrid.Hub.Api/Dockerfile
    image: ghcr.io/frankseins/myiotgrid-hub-phx-api:latest
    container_name: myIoTGrid.Hub
    restart: unless-stopped
    ports:
      - "5001:5001"
      - "5000:5000"
      - "5002:5002"
      - "5001:5001/udp"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=https://+:5001;http://+:5000;http://+:5002
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/app/certs/fullchain.pem
      - ASPNETCORE_Kestrel__Certificates__Default__KeyPath=/app/certs/privkey.pem
      # Explizite Kestrel Endpoints (Ã¼berschreiben ASPNETCORE_URLS)
      - Kestrel__Endpoints__Https__Url=https://+:5001
      - Kestrel__Endpoints__Https__Certificate__Path=/app/certs/fullchain.pem
      - Kestrel__Endpoints__Https__Certificate__KeyPath=/app/certs/privkey.pem
      - Kestrel__Endpoints__Http__Url=http://+:5000
      - Kestrel__Endpoints__Http2__Url=http://+:5002
      - ConnectionStrings__HubDb=Data Source=/app/data/hub.db
      - Mqtt__Host=host.docker.internal
      - Mqtt__Port=1883
      - LoRaWAN__MqttServer=tcp://host.docker.internal:1884
      - Hub__DefaultTenantName=Default
      - Discovery__Enabled=true
      - Discovery__Port=5001
      - Discovery__Protocol=https
      - Discovery__ApiPort=5001
    volumes:
      - hub-data:/app/data
      - hub-logs:/app/logs
      - hub-certs:/app/certs
    networks:
      - myiotgrid-network
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.myiotgrid.service=hub-api"
      - "com.myiotgrid.description=Backend API (HTTPS)"

  # ---------------------------------------------------------------------------
  # Frontend (Angular + nginx with HTTPS) - Port 443
  # ---------------------------------------------------------------------------
  hub-frontend:
    build:
      context: ./myIoTGrid.Apps
      dockerfile: docker/Dockerfile.hub
    image: ghcr.io/frankseins/myiotgrid-hub-phx-frontend:latest
    container_name: myIoTGrid.Frontend
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    environment:
      # Local Docker: use internal Docker network DNS
      # Azure: default is https://phx-api.myiotgrid.cloud (set in Dockerfile)
      - API_BACKEND_URL=https://hub-api:5001
    volumes:
      - ./certs:/etc/nginx/certs:ro
    networks:
      - myiotgrid-network
    depends_on:
      hub-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "--no-check-certificate", "https://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      - "com.myiotgrid.service=hub-frontend"
      - "com.myiotgrid.description=Frontend UI (HTTPS)"

  # ---------------------------------------------------------------------------
  # Sensor Simulator (Native Build) - Auto-discovers Hub via UDP broadcast
  # ---------------------------------------------------------------------------
  sensor-sim:
    build:
      context: ./myIoTGrid.Sensor
      dockerfile: docker/Dockerfile
    image: ghcr.io/frankseins/myiotgrid-phx-sensor-sim:latest
    container_name: myIoTGrid.Sensor
    restart: unless-stopped
    environment:
      # Manual fallback config (used if discovery fails)
      - HUB_HOST=hub-api
      - HUB_PORT=5001
      - HUB_PROTOCOL=https
      - HUB_INSECURE=true
      # Discovery configuration
      - DISCOVERY_ENABLED=true
      - DISCOVERY_PORT=5001
      - SENSOR_ID=sim-sensor-01
      - DATA_DIR=/data
    volumes:
      - sensor-data:/data
    networks:
      - myiotgrid-network
    depends_on:
      hub-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-x", "sensor"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.myiotgrid.service=sensor-sim"
      - "com.myiotgrid.description=Test Sensor Simulator"

# =============================================================================
# Networks
# =============================================================================
networks:
  myiotgrid-network:
    driver: bridge
    name: myiotgrid-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  hub-data:
    name: myiotgrid-hub-data
  hub-logs:
    name: myiotgrid-hub-logs
  hub-certs:
    name: myiotgrid-hub-certs
  sensor-data:
    name: myiotgrid-sensor-data
