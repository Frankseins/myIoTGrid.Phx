<div class="sensor-type-form-container">
  @if (isLoading()) {
    <myiotgrid-loading-spinner message="Lade Sensortyp..."></myiotgrid-loading-spinner>
  } @else {
    <div class="card outlook">
      <!-- Toolbar -->
      <div class="toolbar outlook-toolbar">
        <button mat-icon-button class="tbar-icon" matTooltip="Zurück zur Liste" (click)="onBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>

        <span class="toolbar-title">{{ pageTitle() }}</span>
        <span class="spacer"></span>

        <!-- Lock/Unlock Button (nur bei vorhandenen Datensätzen, nicht bei Create) -->
        @if (!isCreateMode()) {
          <button mat-icon-button class="tbar-icon"
                  [class.warn]="!isViewMode()"
                  [matTooltip]="isViewMode() ? 'Bearbeiten aktivieren' : 'Bearbeitung aktiv'"
                  (click)="toggleEditMode()">
            <mat-icon>{{ isViewMode() ? 'lock' : 'lock_open' }}</mat-icon>
          </button>
        }
      </div>

      <!-- Content -->
      <div class="content">
        <form [formGroup]="form" (ngSubmit)="onSave()">

          <!-- Basic Information -->
          <section class="form-section">
            <h3>Allgemein</h3>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Code</mat-label>
                <input matInput formControlName="code" [readonly]="isViewMode() || !isCreateMode()" placeholder="z.B. dht22">
                @if (!isViewMode()) {
                  <mat-hint>Eindeutiger Code (nur Kleinbuchstaben, Zahlen, Bindestriche, Unterstriche)</mat-hint>
                }
                @if (form.get('code')?.hasError('required')) {
                  <mat-error>Code ist erforderlich</mat-error>
                }
                @if (form.get('code')?.hasError('pattern')) {
                  <mat-error>Nur Kleinbuchstaben, Zahlen, Bindestriche und Unterstriche erlaubt</mat-error>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Name</mat-label>
                <input matInput formControlName="name" [readonly]="isViewMode()" placeholder="z.B. DHT22 Temperatur & Feuchte">
                @if (form.get('name')?.hasError('required')) {
                  <mat-error>Name ist erforderlich</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Hersteller</mat-label>
                <input matInput formControlName="manufacturer" [readonly]="isViewMode()" placeholder="z.B. AOSONG">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Kategorie</mat-label>
                @if (isViewMode()) {
                  <input matInput [value]="getCategoryLabel(form.get('category')?.value)" readonly>
                  <input type="hidden" [formControl]="$any(form.get('category'))">
                } @else {
                  <mat-select formControlName="category">
                    @for (cat of categories; track cat.value) {
                      <mat-option [value]="cat.value">{{ cat.label }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>
            </div>

            <mat-form-field class="full-width"
                            [appearance]="isViewMode() ? 'fill' : 'outline'"
                            [floatLabel]="isViewMode() ? 'always' : 'auto'">
              <mat-label>Datenblatt URL</mat-label>
              <input matInput formControlName="datasheetUrl" [readonly]="isViewMode()" placeholder="https://...">
            </mat-form-field>

            <mat-form-field class="full-width"
                            [appearance]="isViewMode() ? 'fill' : 'outline'"
                            [floatLabel]="isViewMode() ? 'always' : 'auto'">
              <mat-label>Beschreibung</mat-label>
              <textarea matInput formControlName="description" [readonly]="isViewMode()" rows="3"
                        placeholder="Optionale Beschreibung des Sensortyps"></textarea>
            </mat-form-field>
          </section>

          <mat-divider></mat-divider>

          <!-- Communication Protocol -->
          <section class="form-section">
            <h3>Kommunikationsprotokoll</h3>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Protokoll</mat-label>
                @if (isViewMode()) {
                  <input matInput [value]="getProtocolLabel(form.get('protocol')?.value)" readonly>
                  <input type="hidden" [formControl]="$any(form.get('protocol'))">
                } @else {
                  <mat-select formControlName="protocol">
                    @for (proto of protocols; track proto.value) {
                      <mat-option [value]="proto.value">{{ proto.label }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Standard I2C-Adresse</mat-label>
                <input matInput formControlName="defaultI2CAddress" [readonly]="isViewMode()" placeholder="z.B. 0x40">
                @if (!isViewMode()) {
                  <mat-hint>Hexadezimal, z.B. 0x40</mat-hint>
                }
              </mat-form-field>
            </div>

            <div class="form-row four-col">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>SDA Pin</mat-label>
                <input matInput type="number" formControlName="defaultSdaPin" [readonly]="isViewMode()">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>SCL Pin</mat-label>
                <input matInput type="number" formControlName="defaultSclPin" [readonly]="isViewMode()">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>1-Wire Pin</mat-label>
                <input matInput type="number" formControlName="defaultOneWirePin" [readonly]="isViewMode()">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Analog Pin</mat-label>
                <input matInput type="number" formControlName="defaultAnalogPin" [readonly]="isViewMode()">
              </mat-form-field>
            </div>

            <div class="form-row four-col">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Digital Pin</mat-label>
                <input matInput type="number" formControlName="defaultDigitalPin" [readonly]="isViewMode()">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Trigger Pin</mat-label>
                <input matInput type="number" formControlName="defaultTriggerPin" [readonly]="isViewMode()">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Echo Pin</mat-label>
                <input matInput type="number" formControlName="defaultEchoPin" [readonly]="isViewMode()">
              </mat-form-field>
            </div>
          </section>

          <mat-divider></mat-divider>

          <!-- Timing & Calibration -->
          <section class="form-section">
            <h3>Timing & Kalibrierung</h3>

            <div class="form-row three-col">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Standard-Intervall (Sek)</mat-label>
                <input matInput type="number" formControlName="defaultIntervalSeconds" [readonly]="isViewMode()">
                @if (!isViewMode()) {
                  <mat-hint>Messintervall in Sekunden</mat-hint>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Min. Intervall (Sek)</mat-label>
                <input matInput type="number" formControlName="minIntervalSeconds" [readonly]="isViewMode()">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Aufwärmzeit (ms)</mat-label>
                <input matInput type="number" formControlName="warmupTimeMs" [readonly]="isViewMode()">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Offset-Korrektur</mat-label>
                <input matInput type="number" step="0.01" formControlName="defaultOffsetCorrection" [readonly]="isViewMode()">
                @if (!isViewMode()) {
                  <mat-hint>Wird zum Messwert addiert</mat-hint>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Gain-Korrektur</mat-label>
                <input matInput type="number" step="0.01" formControlName="defaultGainCorrection" [readonly]="isViewMode()">
                @if (!isViewMode()) {
                  <mat-hint>Messwert wird damit multipliziert</mat-hint>
                }
              </mat-form-field>
            </div>
          </section>

          <mat-divider></mat-divider>

          <!-- Capabilities (only for create mode) -->
          @if (isCreateMode()) {
            <section class="form-section">
              <h3>
                Messfähigkeiten
                <button mat-icon-button type="button" (click)="addCapability()" color="primary">
                  <mat-icon>add_circle</mat-icon>
                </button>
              </h3>

              @for (capability of capabilitiesArray.controls; track $index; let i = $index) {
                <mat-expansion-panel [formGroup]="$any(capability)">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      {{ capability.get('displayName')?.value || 'Neue Messfähigkeit' }}
                    </mat-panel-title>
                    <mat-panel-description>
                      {{ capability.get('measurementType')?.value }}
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Messtyp</mat-label>
                      <input matInput formControlName="measurementType" placeholder="z.B. temperature">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Anzeigename</mat-label>
                      <input matInput formControlName="displayName" placeholder="z.B. Temperatur">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Einheit</mat-label>
                      <input matInput formControlName="unit" placeholder="z.B. °C">
                    </mat-form-field>
                  </div>

                  <div class="form-row four-col">
                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Min. Wert</mat-label>
                      <input matInput type="number" formControlName="minValue">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Max. Wert</mat-label>
                      <input matInput type="number" formControlName="maxValue">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Auflösung</mat-label>
                      <input matInput type="number" step="0.01" formControlName="resolution">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Genauigkeit</mat-label>
                      <input matInput type="number" step="0.1" formControlName="accuracy">
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Matter Cluster ID</mat-label>
                      <input matInput type="number" formControlName="matterClusterId">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Matter Cluster Name</mat-label>
                      <input matInput formControlName="matterClusterName">
                    </mat-form-field>
                  </div>

                  <mat-action-row>
                    <button mat-button color="warn" type="button" (click)="removeCapability(i)">
                      <mat-icon>delete</mat-icon>
                      Entfernen
                    </button>
                  </mat-action-row>
                </mat-expansion-panel>
              }
            </section>

            <mat-divider></mat-divider>
          }

          <!-- Appearance -->
          <section class="form-section">
            <h3>Darstellung</h3>

            <div class="icon-selector">
              <label>Icon</label>
              <div class="icon-grid">
                @for (icon of standardIcons; track icon) {
                  <button type="button" mat-icon-button
                          [class.selected]="form.get('icon')?.value === icon"
                          [disabled]="isViewMode()"
                          (click)="selectIcon(icon)">
                    <mat-icon>{{ icon }}</mat-icon>
                  </button>
                }
              </div>
            </div>

            <div class="color-selector">
              <label>Farbe</label>
              <div class="color-grid">
                @for (color of presetColors; track color) {
                  <button type="button" class="color-swatch"
                          [style.background-color]="color"
                          [class.selected]="form.get('color')?.value === color"
                          [disabled]="isViewMode()"
                          (click)="selectColor(color)">
                  </button>
                }
              </div>
              <mat-form-field class="color-input"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Farbe (Hex)</mat-label>
                <input matInput formControlName="color" [readonly]="isViewMode()" placeholder="#607d8b">
              </mat-form-field>
            </div>

            <!-- Preview -->
            <div class="preview">
              <label>Vorschau</label>
              <div class="preview-icon" [style.background-color]="form.get('color')?.value">
                <mat-icon>{{ form.get('icon')?.value }}</mat-icon>
              </div>
              <span class="preview-name">{{ form.get('name')?.value || 'Sensortyp' }}</span>
            </div>
          </section>
        </form>
      </div>

      <!-- Footer Action Bar (nur im Edit/Create Modus sichtbar) -->
      @if (!isViewMode()) {
        <div class="form-footer">
          <div class="actions">
            <button mat-button type="button" (click)="onCancel()">
              <mat-icon>close</mat-icon>
              Abbrechen
            </button>
            <button mat-flat-button color="primary" type="button"
                    [disabled]="form.invalid || isSaving()"
                    (click)="onSave()">
              <mat-icon>{{ isSaving() ? 'sync' : 'check' }}</mat-icon>
              {{ isSaving() ? 'Speichern...' : (isCreateMode() ? 'Erstellen' : 'Speichern') }}
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>
