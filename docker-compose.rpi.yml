# =============================================================================
# myIoTGrid - Raspberry Pi Docker Stack
# =============================================================================
# Services:
# - hub-api:      Backend API (.NET 10) - Port 5000/5001/5002 (host network)
# - hub-frontend: Frontend (Angular/nginx) - Port 443 (HTTPS)
# - sensor-sim:   Sensor Simulator (Native) - Test sensor with auto-discovery
#
# Note: hub-api uses network_mode: host for Bluetooth/D-Bus access
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API (.NET 10) - Host Network Mode for Bluetooth
  # ---------------------------------------------------------------------------
  hub-api:
    image: ghcr.io/frankseins/myiotgrid-hub-phx-api:latest
    container_name: myIoTGrid.Hub
    restart: unless-stopped
    # Bluetooth requirements
    privileged: true
    network_mode: host
    user: root
    devices:
      - /dev:/dev
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=https://+:5001;http://+:5000;http://+:5002
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/app/certs/fullchain.pem
      - ASPNETCORE_Kestrel__Certificates__Default__KeyPath=/app/certs/privkey.pem
      # Explizite Kestrel Endpoints
      - Kestrel__Endpoints__Https__Url=https://+:5001
      - Kestrel__Endpoints__Https__Certificate__Path=/app/certs/fullchain.pem
      - Kestrel__Endpoints__Https__Certificate__KeyPath=/app/certs/privkey.pem
      - Kestrel__Endpoints__Http__Url=http://+:5000
      - Kestrel__Endpoints__Http2__Url=http://+:5002
      - ConnectionStrings__HubDb=Data Source=/app/data/hub.db
      # MQTT - localhost weil host network
      - Mqtt__Host=localhost
      - Mqtt__Port=1883
      # LoRaWAN Integration
      - LoRaWAN__Enabled=true
      - LoRaWAN__MqttServer=tcp://localhost:1884
      - LoRaWAN__ClientId=myiotgrid-hub-lorawan
      - Hub__DefaultTenantName=Default
      - Discovery__Enabled=true
      - Discovery__Port=5001
      - Discovery__Protocol=https
      - Discovery__ApiPort=5001
      # Bluetooth Low Energy (BLE) Scanner
      - Ble__Enabled=true
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
    volumes:
      - hub-data:/app/data
      - hub-logs:/app/logs
      - ./certs:/app/certs:ro
      - /var/run/dbus:/var/run/dbus  # D-Bus for BlueZ (no :ro for write access)
    # Note: no ports/networks needed with network_mode: host
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.myiotgrid.service=hub-api"
      - "com.myiotgrid.description=Backend API (Bluetooth enabled)"

  # ---------------------------------------------------------------------------
  # Frontend (Angular + nginx with HTTPS) - Port 443
  # ---------------------------------------------------------------------------
  hub-frontend:
    image: ghcr.io/frankseins/myiotgrid-hub-phx-frontend:latest
    container_name: myIoTGrid.Frontend
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    environment:
      - API_BACKEND_URL=http://hub-api:5000
    extra_hosts:
      - "hub-api:host-gateway"  # Maps hub-api to host IP (for network_mode: host)
    volumes:
      - ./certs:/etc/nginx/certs:ro
    networks:
      - myiotgrid-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "--no-check-certificate", "https://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      - "com.myiotgrid.service=hub-frontend"
      - "com.myiotgrid.description=Frontend UI (HTTPS)"

  # ---------------------------------------------------------------------------
  # Sensor Simulator (Native Build) - Auto-discovers Hub via UDP broadcast
  # ---------------------------------------------------------------------------
  sensor-sim:
    image: ghcr.io/frankseins/myiotgrid-phx-sensor-sim:latest
    container_name: myIoTGrid.Sensor
    restart: unless-stopped
    environment:
      - HUB_HOST=hub-api
      - HUB_PORT=5001
      - HUB_PROTOCOL=https
      - HUB_INSECURE=true
      - DISCOVERY_ENABLED=true
      - DISCOVERY_PORT=5001
      - SENSOR_ID=sim-sensor-01
      - DATA_DIR=/data
    extra_hosts:
      - "hub-api:host-gateway"  # Maps hub-api to host IP
    volumes:
      - sensor-data:/data
    networks:
      - myiotgrid-network
    healthcheck:
      test: ["CMD", "pgrep", "-x", "sensor"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.myiotgrid.service=sensor-sim"
      - "com.myiotgrid.description=Test Sensor Simulator"

# =============================================================================
# Networks
# =============================================================================
networks:
  myiotgrid-network:
    driver: bridge
    name: myiotgrid-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  hub-data:
    name: myiotgrid-hub-data
  hub-logs:
    name: myiotgrid-hub-logs
  sensor-data:
    name: myiotgrid-sensor-data
