<div class="hub-settings-page">
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">Einstellungen</h1>
      <p class="page-subtitle">Hub-Konfiguration und System-Informationen</p>
    </div>
    @if (!isLoading() && hub()) {
      <div class="header-actions">
        <button
          mat-icon-button
          [matTooltip]="isViewMode() ? 'Bearbeiten' : 'Abbrechen'"
          (click)="toggleEditMode()">
          <mat-icon>{{ isViewMode() ? 'edit' : 'lock' }}</mat-icon>
        </button>
      </div>
    }
  </header>

  @if (isLoading()) {
    <myiotgrid-loading-spinner message="Hub-Einstellungen werden geladen..."></myiotgrid-loading-spinner>
  } @else if (!hub()) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <p>Hub nicht initialisiert. Bitte starten Sie die Anwendung neu.</p>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="settings-grid">
      <!-- Row 1: Status | Konfiguration | Dienste -->

      <!-- Status Card -->
      <mat-card class="status-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>hub</mat-icon>
            Status
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="status-indicator" [class]="getStatusClass()">
            <mat-icon>{{ getStatusIcon() }}</mat-icon>
            <span class="status-text">{{ getStatusText() }}</span>
          </div>

          <div class="status-details">
            <div class="detail-row">
              <span class="label">Hub-ID:</span>
              <code class="value">{{ hub()?.hubId }}</code>
            </div>
            <div class="detail-row">
              <span class="label">Zuletzt gesehen:</span>
              <span class="value">
                @if (hub()?.lastSeen) {
                  {{ hub()?.lastSeen | relativeTime }}
                } @else {
                  <span class="no-data">–</span>
                }
              </span>
            </div>
            <div class="detail-row">
              <span class="label">Erstellt am:</span>
              <span class="value">{{ hub()?.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
            </div>
          </div>

          @if (status()) {
            <mat-divider></mat-divider>
            <div class="node-stats">
              <h4>Nodes</h4>
              <div class="stat-row">
                <span class="stat-label">Gesamt:</span>
                <span class="stat-value">{{ status()?.nodeCount }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Online:</span>
                <span class="stat-value online">{{ status()?.onlineNodeCount }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Offline:</span>
                <span class="stat-value offline">{{ (status()?.nodeCount || 0) - (status()?.onlineNodeCount || 0) }}</span>
              </div>
              <button
                mat-stroked-button
                color="primary"
                class="view-nodes-btn"
                (click)="navigateToNodes()">
                <mat-icon>device_hub</mat-icon>
                Nodes verwalten
              </button>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Settings Form Card -->
      <mat-card class="settings-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>settings</mat-icon>
            Konfiguration
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="form" (ngSubmit)="onSave()">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Name</mat-label>
              <input
                matInput
                formControlName="name"
                placeholder="Hub-Name"
                [readonly]="isViewMode()">
              @if (form.get('name')?.hasError('required')) {
                <mat-error>Name ist erforderlich</mat-error>
              }
              @if (form.get('name')?.hasError('minlength')) {
                <mat-error>Name muss mindestens 2 Zeichen haben</mat-error>
              }
              @if (form.get('name')?.hasError('maxlength')) {
                <mat-error>Name darf maximal 200 Zeichen haben</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Beschreibung</mat-label>
              <textarea
                matInput
                formControlName="description"
                placeholder="Optionale Beschreibung"
                [readonly]="isViewMode()"
                rows="3"></textarea>
              @if (form.get('description')?.hasError('maxlength')) {
                <mat-error>Beschreibung darf maximal 500 Zeichen haben</mat-error>
              }
            </mat-form-field>

            @if (isEditMode()) {
              <div class="form-actions">
                <button
                  mat-button
                  type="button"
                  (click)="onCancel()"
                  [disabled]="isSaving()">
                  Abbrechen
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="form.invalid || isSaving()">
                  <ng-container>
                    <mat-icon *ngIf="isSaving()" class="spin">sync</mat-icon>
                    <mat-icon *ngIf="!isSaving()">save</mat-icon>
                  </ng-container>
                  {{ isSaving() ? 'Speichern...' : 'Speichern' }}
                </button>
              </div>
            }
          </form>
        </mat-card-content>
      </mat-card>

      <!-- Services Status Card -->
      <mat-card class="services-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>dns</mat-icon>
            Dienste
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="services-list">
            <!-- API -->
            <div class="service-item" [class.online]="status()?.services?.api?.isOnline" [class.offline]="!status()?.services?.api?.isOnline">
              <mat-icon>api</mat-icon>
              <div class="service-info">
                <span class="service-name">Backend API</span>
                <span class="service-status">{{ status()?.services?.api?.message || (status()?.services?.api?.isOnline ? 'Online' : 'Offline') }}</span>
              </div>
              <mat-icon class="status-icon">{{ status()?.services?.api?.isOnline ? 'check_circle' : 'cancel' }}</mat-icon>
            </div>

            <!-- Database -->
            <div class="service-item" [class.online]="status()?.services?.database?.isOnline" [class.offline]="!status()?.services?.database?.isOnline">
              <mat-icon>storage</mat-icon>
              <div class="service-info">
                <span class="service-name">Datenbank</span>
                <span class="service-status">{{ status()?.services?.database?.message || (status()?.services?.database?.isOnline ? 'Verbunden' : 'Nicht verbunden') }}</span>
              </div>
              <mat-icon class="status-icon">{{ status()?.services?.database?.isOnline ? 'check_circle' : 'cancel' }}</mat-icon>
            </div>

            <!-- MQTT -->
            <div class="service-item" [class.online]="status()?.services?.mqtt?.isOnline" [class.offline]="!status()?.services?.mqtt?.isOnline" [class.not-configured]="status()?.services?.mqtt?.message === 'Not configured'">
              <mat-icon>router</mat-icon>
              <div class="service-info">
                <span class="service-name">MQTT Broker</span>
                <span class="service-status">{{ status()?.services?.mqtt?.message === 'Not configured' ? 'Nicht konfiguriert' : (status()?.services?.mqtt?.isOnline ? 'Verbunden' : 'Nicht verbunden') }}</span>
              </div>
              <mat-icon class="status-icon">{{ status()?.services?.mqtt?.message === 'Not configured' ? 'remove_circle_outline' : (status()?.services?.mqtt?.isOnline ? 'check_circle' : 'cancel') }}</mat-icon>
            </div>

            <!-- Cloud -->
            <div class="service-item" [class.online]="status()?.services?.cloud?.isOnline" [class.offline]="!status()?.services?.cloud?.isOnline" [class.not-configured]="status()?.services?.cloud?.message === 'Not configured'">
              <mat-icon>cloud</mat-icon>
              <div class="service-info">
                <span class="service-name">Cloud-Verbindung</span>
                <span class="service-status">{{ status()?.services?.cloud?.message === 'Not configured' ? 'Nicht konfiguriert' : (status()?.services?.cloud?.isOnline ? 'Verbunden' : 'Nicht verbunden') }}</span>
              </div>
              <mat-icon class="status-icon">{{ status()?.services?.cloud?.message === 'Not configured' ? 'remove_circle_outline' : (status()?.services?.cloud?.isOnline ? 'check_circle' : 'cancel') }}</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Row 2: Node Provisioning | Cloud | Smart Home -->

      <!-- Node Provisioning Card -->
      <mat-card class="provisioning-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bluetooth</mat-icon>
            Node-Provisioning
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p class="card-description">Standard-Einstellungen für neue Sensor-Nodes (BLE Setup)</p>
          <form [formGroup]="form" (ngSubmit)="onSave()">
            <div class="provisioning-section">
              <h4>WiFi-Einstellungen</h4>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>WiFi SSID</mat-label>
                <input
                  matInput
                  formControlName="defaultWifiSsid"
                  placeholder="Ihr WiFi-Netzwerk"
                  [readonly]="isViewMode()">
                <mat-icon matSuffix>wifi</mat-icon>
                @if (form.get('defaultWifiSsid')?.hasError('maxlength')) {
                  <mat-error>SSID darf maximal 32 Zeichen haben</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>WiFi Passwort</mat-label>
                <input
                  matInput
                  formControlName="defaultWifiPassword"
                  [type]="isViewMode() ? 'password' : 'text'"
                  placeholder="WiFi-Passwort"
                  [readonly]="isViewMode()">
                <mat-icon matSuffix>lock</mat-icon>
                @if (form.get('defaultWifiPassword')?.hasError('maxlength')) {
                  <mat-error>Passwort darf maximal 64 Zeichen haben</mat-error>
                }
              </mat-form-field>
            </div>

            <mat-divider></mat-divider>

            <div class="provisioning-section">
              <h4>API-Verbindung</h4>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Hub API URL</mat-label>
                <input
                  matInput
                  formControlName="apiUrl"
                  placeholder="http://192.168.1.100"
                  [readonly]="isViewMode()">
                <mat-icon matSuffix>link</mat-icon>
                <mat-hint>IP-Adresse oder Hostname des Hubs</mat-hint>
                @if (form.get('apiUrl')?.hasError('maxlength')) {
                  <mat-error>URL darf maximal 200 Zeichen haben</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>API Port</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="apiPort"
                  placeholder="5002"
                  [readonly]="isViewMode()">
                <mat-icon matSuffix>settings_ethernet</mat-icon>
                @if (form.get('apiPort')?.hasError('min') || form.get('apiPort')?.hasError('max')) {
                  <mat-error>Port muss zwischen 1 und 65535 liegen</mat-error>
                }
              </mat-form-field>
            </div>

            @if (isEditMode()) {
              <div class="form-actions">
                <button
                  mat-button
                  type="button"
                  (click)="onCancel()"
                  [disabled]="isSaving()">
                  Abbrechen
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="form.invalid || isSaving()">
                  <ng-container>
                    <mat-icon *ngIf="isSaving()" class="spin">sync</mat-icon>
                    <mat-icon *ngIf="!isSaving()">save</mat-icon>
                  </ng-container>
                  {{ isSaving() ? 'Speichern...' : 'Speichern' }}
                </button>
              </div>
            }
          </form>
        </mat-card-content>
      </mat-card>

      <!-- Cloud Connection Card -->
      <mat-card class="cloud-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>cloud_off</mat-icon>
            Cloud-Verbindung
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="cloud-not-configured">
            <mat-icon class="cloud-icon">cloud_off</mat-icon>
            <p>Cloud-Verbindung ist nicht eingerichtet.</p>
            <p class="hint">Verbinden Sie Ihren Hub mit der myIoTGrid Cloud für KI-Analyse und Remote-Zugriff.</p>
            <button mat-stroked-button color="primary" disabled>
              <mat-icon>link</mat-icon>
              Mit Cloud verbinden
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Smart Home Card -->
      <mat-card class="smarthome-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>home</mat-icon>
            Smart Home
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="matter-info">
            <mat-icon class="matter-icon">qr_code_2</mat-icon>
            <p>Matter-Pairing ist bereit. Scannen Sie den QR-Code in Ihrer Smart Home App.</p>
            <button mat-stroked-button color="primary" disabled>
              <mat-icon>qr_code</mat-icon>
              QR-Code anzeigen
            </button>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  }
</div>
