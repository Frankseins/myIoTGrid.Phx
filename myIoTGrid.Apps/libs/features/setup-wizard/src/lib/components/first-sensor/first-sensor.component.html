<div class="first-sensor-container">
  <mat-card class="sensor-card">
    <mat-card-header>
      <mat-icon mat-card-avatar class="step-icon">sensors</mat-icon>
      <mat-card-title>Sensoren zuordnen</mat-card-title>
      <mat-card-subtitle>Schritt 4 von 5 - Optional</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="node-info-summary">
        <mat-icon>{{ nodeInfo()?.icon || 'memory' }}</mat-icon>
        <div class="summary-text">
          <strong>{{ nodeInfo()?.name }}</strong>
          @if (nodeInfo()?.location) {
            <span class="location">{{ nodeInfo()?.location }}</span>
          }
        </div>
      </div>

      <div class="sensor-selection">
        <!-- Existing Sensors from API -->
        <div class="section">
          <h3>Sensoren zuordnen</h3>
          <p class="section-description">
            Wählen Sie die Sensoren aus, die diesem Node zugeordnet werden sollen (Mehrfachauswahl möglich)
          </p>

          @if (isLoadingSensors()) {
            <div class="loading-indicator">
              <mat-spinner diameter="24"></mat-spinner>
              <span>Lade Sensoren...</span>
            </div>
          } @else if (existingSensors().length === 0) {
            <div class="no-sensors-info">
              <mat-icon>info</mat-icon>
              <p>Keine Sensoren vorhanden. Sie können Sensoren später unter "Sensoren" anlegen und diesem Node zuordnen.</p>
            </div>
          } @else {
            <div class="sensor-grid">
              @for (sensor of existingSensors(); track sensor.id) {
                <div
                  class="sensor-card"
                  [class.selected]="isSensorSelected(sensor)"
                  (click)="toggleSensorSelection(sensor)"
                  (keydown.enter)="toggleSensorSelection(sensor)"
                  (keydown.space)="toggleSensorSelection(sensor)"
                  tabindex="0"
                  role="option"
                  [attr.aria-selected]="isSensorSelected(sensor)"
                >
                  @if (isSensorSelected(sensor)) {
                    <mat-icon class="check-icon">check_circle</mat-icon>
                  }
                  <mat-icon class="sensor-icon">{{ sensor.icon || 'sensors' }}</mat-icon>
                  <span class="sensor-name">{{ sensor.name }}</span>
                  <span class="sensor-protocol">{{ getProtocolLabel(sensor.protocol) }}</span>
                </div>
              }
            </div>
          }
        </div>

        <!-- Selected Sensors Summary -->
        @if (selectedSensors().length > 0) {
          <div class="section selected-summary">
            <h3>
              <mat-icon>check_circle</mat-icon>
              {{ selectedSensors().length }} Sensor{{ selectedSensors().length > 1 ? 'en' : '' }} ausgewählt
            </h3>
            <div class="selected-sensors-list">
              @for (sensor of selectedSensors(); track sensor.id) {
                <div class="selected-sensor-chip">
                  <mat-icon>{{ sensor.icon || 'sensors' }}</mat-icon>
                  <span>{{ sensor.name }}</span>
                  <button mat-icon-button (click)="toggleSensorSelection(sensor)" class="remove-btn">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          </div>
        }
      </div>

      @if (isCreating()) {
        <div class="creating-overlay">
          <mat-spinner diameter="48"></mat-spinner>
          <h3>Node wird erstellt...</h3>
          <p>Bitte warten Sie einen Moment</p>
        </div>
      }
    </mat-card-content>

    <mat-divider></mat-divider>

    <mat-card-actions align="end">
      <button mat-button (click)="onCancel()">
        Abbrechen
      </button>
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon>
        Zurück
      </button>
      <button mat-button (click)="onSkip()">
        Überspringen
      </button>
      <button
        mat-flat-button
        color="primary"
        [disabled]="selectedSensors().length === 0 || isCreating()"
        (click)="onComplete()"
      >
        <mat-icon>check</mat-icon>
        Abschließen
      </button>
    </mat-card-actions>
  </mat-card>
</div>
