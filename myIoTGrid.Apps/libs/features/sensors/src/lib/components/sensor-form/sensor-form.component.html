<div class="sensor-form-container">
  @if (isLoading()) {
    <myiotgrid-loading-spinner message="Lade Sensor..."></myiotgrid-loading-spinner>
  } @else {
    <div class="card outlook">
      <!-- Toolbar -->
      <div class="toolbar outlook-toolbar">
        <button mat-icon-button class="tbar-icon" matTooltip="Zurück zur Liste" (click)="onBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>

        <span class="toolbar-title">{{ pageTitle() }}</span>
        <span class="spacer"></span>

        <!-- Lock/Unlock Button (nur bei vorhandenen Datensätzen, nicht bei Create) -->
        @if (!isCreateMode()) {
          <button mat-icon-button class="tbar-icon"
                  [class.warn]="!isViewMode()"
                  [matTooltip]="isViewMode() ? 'Bearbeiten aktivieren' : 'Bearbeitung aktiv'"
                  (click)="toggleEditMode()">
            <mat-icon>{{ isViewMode() ? 'lock' : 'lock_open' }}</mat-icon>
          </button>
        }
      </div>

      <!-- Content -->
      <div class="content">
        <form [formGroup]="form" (ngSubmit)="onSave()">

          <!-- Basic Information -->
          <section class="form-section">
            <h3>Allgemein</h3>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Code</mat-label>
                <input matInput formControlName="code" [readonly]="isViewMode() || isEditMode()"
                       placeholder="z.B. dht22-wohnzimmer">
                @if (isEditMode()) {
                  <mat-hint>Code kann nicht geändert werden</mat-hint>
                }
                @if (form.get('code')?.hasError('required')) {
                  <mat-error>Code ist erforderlich</mat-error>
                }
                @if (form.get('code')?.hasError('pattern')) {
                  <mat-error>Nur Kleinbuchstaben, Zahlen und Bindestriche erlaubt</mat-error>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Name</mat-label>
                <input matInput formControlName="name" [readonly]="isViewMode()"
                       placeholder="z.B. DHT22 Wohnzimmer">
                @if (form.get('name')?.hasError('required')) {
                  <mat-error>Name ist erforderlich</mat-error>
                }
                @if (form.get('name')?.hasError('minlength')) {
                  <mat-error>Name muss mindestens 2 Zeichen haben</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Protokoll</mat-label>
                @if (isViewMode()) {
                  <input matInput [value]="protocolLabel()" readonly>
                } @else {
                  <mat-select formControlName="protocol">
                    @for (option of protocolOptions; track option.value) {
                      <mat-option [value]="option.value">{{ option.label }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Kategorie</mat-label>
                @if (isViewMode()) {
                  <input matInput [value]="form.get('category')?.value" readonly>
                } @else {
                  <mat-select formControlName="category">
                    @for (option of categoryOptions; track option.value) {
                      <mat-option [value]="option.value">{{ option.label }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Hersteller</mat-label>
                <input matInput formControlName="manufacturer" [readonly]="isViewMode()"
                       placeholder="z.B. Bosch, Aosong">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Modell</mat-label>
                <input matInput formControlName="model" [readonly]="isViewMode()"
                       placeholder="z.B. BME280, DHT22">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Seriennummer</mat-label>
                <input matInput formControlName="serialNumber" [readonly]="isViewMode()"
                       placeholder="z.B. SN-001234">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Datenblatt URL</mat-label>
                <input matInput formControlName="datasheetUrl" [readonly]="isViewMode()"
                       placeholder="https://...">
              </mat-form-field>
            </div>

            <mat-form-field class="full-width"
                            [appearance]="isViewMode() ? 'fill' : 'outline'"
                            [floatLabel]="isViewMode() ? 'always' : 'auto'">
              <mat-label>Beschreibung</mat-label>
              <textarea matInput formControlName="description" [readonly]="isViewMode()" rows="3"
                        placeholder="Optionale Beschreibung des Sensors"></textarea>
            </mat-form-field>
          </section>

          <mat-divider></mat-divider>

          <!-- Timing Configuration -->
          <section class="form-section">
            <h3>Messintervall</h3>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Abfrageintervall (Sekunden)</mat-label>
                <input matInput type="number" formControlName="intervalSeconds" [readonly]="isViewMode()">
                <mat-hint>Wie oft der Sensor abgefragt wird</mat-hint>
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Minimales Intervall (Sekunden)</mat-label>
                <input matInput type="number" formControlName="minIntervalSeconds" [readonly]="isViewMode()">
                <mat-hint>Kürzestes erlaubtes Intervall</mat-hint>
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Aufwärmzeit (ms)</mat-label>
                <input matInput type="number" formControlName="warmupTimeMs" [readonly]="isViewMode()">
                <mat-hint>Zeit bis zur ersten Messung</mat-hint>
              </mat-form-field>
            </div>
          </section>

          <mat-divider></mat-divider>

          <!-- Pin Configuration -->
          @if (showPinConfiguration()) {
            <section class="form-section">
              <h3>Pin-Konfiguration</h3>
              <p class="section-hint">
                Hardware-Pin-Belegung für den Sensor
              </p>

              <!-- I2C Pins -->
              @if (showI2CPins()) {
                <div class="pin-group">
                  <h4 class="pin-group-title">
                    <mat-icon>memory</mat-icon>
                    I²C Konfiguration
                  </h4>

                  <div class="form-row">
                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>I²C Adresse</mat-label>
                      <input matInput formControlName="i2cAddress" [readonly]="isViewMode()"
                             placeholder="z.B. 0x76">
                    </mat-form-field>

                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>SDA Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="sdaPin" [readonly]="isViewMode()"
                             placeholder="z.B. 21">
                    </mat-form-field>

                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>SCL Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="sclPin" [readonly]="isViewMode()"
                             placeholder="z.B. 22">
                    </mat-form-field>
                  </div>
                </div>
              }

              <!-- OneWire Pin -->
              @if (showOneWirePin()) {
                <div class="pin-group">
                  <h4 class="pin-group-title">
                    <mat-icon>cable</mat-icon>
                    1-Wire Konfiguration
                  </h4>

                  <div class="form-row">
                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>OneWire Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="oneWirePin" [readonly]="isViewMode()"
                             placeholder="z.B. 4">
                    </mat-form-field>
                  </div>
                </div>
              }

              <!-- Analog Pin -->
              @if (showAnalogPin()) {
                <div class="pin-group">
                  <h4 class="pin-group-title">
                    <mat-icon>show_chart</mat-icon>
                    Analog Konfiguration
                  </h4>

                  <div class="form-row">
                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>Analog Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="analogPin" [readonly]="isViewMode()"
                             placeholder="z.B. 34">
                    </mat-form-field>
                  </div>
                </div>
              }

              <!-- Digital Pin -->
              @if (showDigitalPin()) {
                <div class="pin-group">
                  <h4 class="pin-group-title">
                    <mat-icon>toggle_on</mat-icon>
                    Digital Konfiguration
                  </h4>

                  <div class="form-row">
                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>Digital Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="digitalPin" [readonly]="isViewMode()"
                             placeholder="z.B. 5">
                    </mat-form-field>
                  </div>
                </div>
              }

              <!-- UltraSonic Pins -->
              @if (showUltraSonicPins()) {
                <div class="pin-group">
                  <h4 class="pin-group-title">
                    <mat-icon>radar</mat-icon>
                    Ultraschall Konfiguration
                  </h4>

                  <div class="form-row">
                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>Trigger Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="triggerPin" [readonly]="isViewMode()"
                             placeholder="z.B. 12">
                    </mat-form-field>

                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>Echo Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="echoPin" [readonly]="isViewMode()"
                             placeholder="z.B. 14">
                    </mat-form-field>

                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>Baudrate (UART-Modus)</mat-label>
                      <input matInput type="number" formControlName="baudRate" [readonly]="isViewMode()"
                             placeholder="z.B. 9600 oder 115200">
                      <mat-hint>Für UART-basierte Ultraschallsensoren (z.B. SR04M-2)</mat-hint>
                    </mat-form-field>
                  </div>
                </div>
              }

              <!-- UART Configuration -->
              @if (showUARTPins()) {
                <div class="pin-group">
                  <h4 class="pin-group-title">
                    <mat-icon>settings_input_hdmi</mat-icon>
                    UART Konfiguration
                  </h4>

                  <div class="form-row">
                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>RX Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="analogPin" [readonly]="isViewMode()"
                             placeholder="z.B. 23">
                      <mat-hint>ESP32 RX empfängt Daten vom Sensor</mat-hint>
                    </mat-form-field>

                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>TX Pin (GPIO)</mat-label>
                      <input matInput type="number" formControlName="digitalPin" [readonly]="isViewMode()"
                             placeholder="z.B. -1 (nicht verwendet)">
                      <mat-hint>-1 für Auto-Mode (nur RX)</mat-hint>
                    </mat-form-field>

                    <mat-form-field class="full"
                                    [appearance]="isViewMode() ? 'fill' : 'outline'"
                                    [floatLabel]="isViewMode() ? 'always' : 'auto'">
                      <mat-label>Baudrate</mat-label>
                      <input matInput type="number" formControlName="baudRate" [readonly]="isViewMode()"
                             placeholder="z.B. 9600 oder 115200">
                      <mat-hint>Übertragungsgeschwindigkeit</mat-hint>
                    </mat-form-field>
                  </div>
                </div>
              }

              @if (!hasPinFields()) {
                <div class="no-pins-info">
                  <mat-icon>info</mat-icon>
                  <span>Für das Protokoll <strong>{{ protocolLabel() }}</strong> sind keine Pin-Konfigurationen erforderlich.</span>
                </div>
              }
            </section>

            <mat-divider></mat-divider>
          }

          <!-- Calibration -->
          <section class="form-section">
            <h3>Kalibrierung</h3>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Offset-Korrektur</mat-label>
                <input matInput type="number" step="0.01" formControlName="offsetCorrection" [readonly]="isViewMode()">
                <mat-hint>Wird zum Messwert addiert</mat-hint>
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Gain-Korrektur</mat-label>
                <input matInput type="number" step="0.01" formControlName="gainCorrection" [readonly]="isViewMode()">
                <mat-hint>Messwert wird damit multipliziert</mat-hint>
              </mat-form-field>
            </div>

            <!-- Kalibrierungsformel Anzeige -->
            <div class="calibration-formula">
              <mat-icon>functions</mat-icon>
              <span>Kalibrierter Wert = {{ getCalibrationFormula() }}</span>
            </div>

            <mat-form-field class="full-width"
                            [appearance]="isViewMode() ? 'fill' : 'outline'"
                            [floatLabel]="isViewMode() ? 'always' : 'auto'">
              <mat-label>Kalibrierungsnotizen</mat-label>
              <textarea matInput formControlName="calibrationNotes" [readonly]="isViewMode()" rows="2"
                        placeholder="Notizen zur Kalibrierung, z.B. Vergleich mit Referenzsensor"></textarea>
            </mat-form-field>
          </section>

          <mat-divider></mat-divider>

          <!-- Appearance -->
          <section class="form-section">
            <h3>Darstellung</h3>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Icon</mat-label>
                <input matInput formControlName="icon" [readonly]="isViewMode()"
                       placeholder="z.B. thermostat, water_drop">
                <mat-icon matSuffix>{{ getIcon() }}</mat-icon>
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Farbe</mat-label>
                <input matInput formControlName="color" [readonly]="isViewMode()" type="color">
              </mat-form-field>
            </div>
          </section>

          <mat-divider></mat-divider>

          <!-- Capabilities -->
          <section class="form-section">
            <div class="section-header">
              <h3>Messwerte (Capabilities)</h3>
              @if (!isViewMode()) {
                <button mat-stroked-button type="button" (click)="addCapability()">
                  <mat-icon>add</mat-icon>
                  Messwert hinzufügen
                </button>
              }
            </div>

            @if (capabilitiesFormArray.length === 0) {
              <div class="no-capabilities">
                <mat-icon>info</mat-icon>
                <span>Keine Messwerte definiert.</span>
              </div>
            } @else {
              <div class="capabilities-list" formArrayName="capabilities">
                @for (cap of capabilitiesFormArray.controls; track cap; let i = $index) {
                  <div class="capability-card" [formGroupName]="i">
                    <div class="capability-header">
                      <span class="capability-number">#{{ i + 1 }}</span>
                      @if (!isViewMode()) {
                        <button mat-icon-button type="button" color="warn"
                                matTooltip="Messwert entfernen"
                                (click)="removeCapability(i)">
                          <mat-icon>delete</mat-icon>
                        </button>
                      }
                    </div>

                    <div class="capability-fields">
                      <div class="form-row">
                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Messtyp</mat-label>
                          @if (isViewMode()) {
                            <input matInput [value]="getMeasurementTypeLabel(cap.get('measurementType')?.value)" readonly>
                          } @else {
                            <mat-select formControlName="measurementType"
                                        (selectionChange)="onMeasurementTypeChange(i, $event.value)">
                              @for (option of measurementTypeOptions; track option.value) {
                                <mat-option [value]="option.value">{{ option.label }}</mat-option>
                              }
                            </mat-select>
                          }
                          @if (cap.get('measurementType')?.hasError('required')) {
                            <mat-error>Messtyp ist erforderlich</mat-error>
                          }
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Anzeigename</mat-label>
                          <input matInput formControlName="displayName" [readonly]="isViewMode()"
                                 placeholder="z.B. Temperatur">
                          @if (cap.get('displayName')?.hasError('required')) {
                            <mat-error>Anzeigename ist erforderlich</mat-error>
                          }
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Einheit</mat-label>
                          @if (isViewMode()) {
                            <input matInput [value]="getUnitLabel(cap.get('unit')?.value)" readonly>
                          } @else {
                            <mat-select formControlName="unit">
                              @for (option of unitOptions; track option.value) {
                                <mat-option [value]="option.value">{{ option.label }}</mat-option>
                              }
                            </mat-select>
                          }
                          @if (cap.get('unit')?.hasError('required')) {
                            <mat-error>Einheit ist erforderlich</mat-error>
                          }
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Min. Wert</mat-label>
                          <input matInput type="number" formControlName="minValue" [readonly]="isViewMode()"
                                 placeholder="z.B. -40">
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Max. Wert</mat-label>
                          <input matInput type="number" formControlName="maxValue" [readonly]="isViewMode()"
                                 placeholder="z.B. 85">
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Auflösung</mat-label>
                          <input matInput type="number" step="0.001" formControlName="resolution" [readonly]="isViewMode()"
                                 placeholder="z.B. 0.01">
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Genauigkeit</mat-label>
                          <input matInput type="number" step="0.1" formControlName="accuracy" [readonly]="isViewMode()"
                                 placeholder="z.B. 0.5">
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Matter Cluster ID</mat-label>
                          <input matInput type="number" formControlName="matterClusterId" [readonly]="isViewMode()"
                                 placeholder="z.B. 1026">
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Matter Cluster Name</mat-label>
                          <input matInput formControlName="matterClusterName" [readonly]="isViewMode()"
                                 placeholder="z.B. TemperatureMeasurement">
                        </mat-form-field>

                        <mat-form-field class="full"
                                        [appearance]="isViewMode() ? 'fill' : 'outline'"
                                        [floatLabel]="isViewMode() ? 'always' : 'auto'">
                          <mat-label>Sortierung</mat-label>
                          <input matInput type="number" formControlName="sortOrder" [readonly]="isViewMode()">
                        </mat-form-field>
                      </div>

                      <mat-checkbox formControlName="isActive" [disabled]="isViewMode()">
                        Aktiv
                      </mat-checkbox>
                    </div>
                  </div>
                }
              </div>
            }
          </section>

          <mat-divider></mat-divider>

          <!-- Status -->
          @if (!isCreateMode()) {
            <section class="form-section">
              <h3>Status</h3>

              <mat-checkbox formControlName="isActive" [disabled]="isViewMode()">
                Sensor aktiv
              </mat-checkbox>
            </section>

            <mat-divider></mat-divider>
          }

          <!-- Preview -->
          <section class="form-section">
            <h3>Vorschau</h3>
            <div class="preview">
              <div class="preview-icon" [style.background-color]="getColor()">
                <mat-icon>{{ getIcon() }}</mat-icon>
              </div>
              <div class="preview-info">
                <span class="preview-name">{{ form.get('name')?.value || 'Sensorname' }}</span>
                <span class="preview-code">{{ form.get('code')?.value || 'sensor-code' }}</span>
                <span class="preview-type">{{ form.get('manufacturer')?.value }} {{ form.get('model')?.value }}</span>
                @if (form.get('serialNumber')?.value) {
                  <code class="preview-serial">{{ form.get('serialNumber')?.value }}</code>
                }
              </div>
            </div>
          </section>
        </form>
      </div>

      <!-- Footer Action Bar (nur im Edit/Create Modus sichtbar) -->
      @if (!isViewMode()) {
        <div class="form-footer">
          <div class="actions">
            <button mat-button type="button" (click)="onCancel()">
              <mat-icon>close</mat-icon>
              Abbrechen
            </button>
            <button mat-flat-button color="primary" type="button"
                    [disabled]="form.invalid || isSaving()"
                    (click)="onSave()">
              <mat-icon>{{ isSaving() ? 'sync' : 'check' }}</mat-icon>
              {{ isSaving() ? 'Speichern...' : (isCreateMode() ? 'Erstellen' : 'Speichern') }}
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>
