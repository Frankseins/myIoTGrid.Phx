<div class="node-list-page">
  @if (!initialLoadDone()) {
    <myiotgrid-loading-spinner message="Nodes werden geladen..."></myiotgrid-loading-spinner>
  } @else if (nodes().length === 0) {
    <div class="empty-state-container">
      <div class="empty-state-content">
        <mat-icon class="empty-state-icon">router</mat-icon>
        <h2 class="empty-state-title">Keine Nodes</h2>
        <p class="empty-state-message">Es wurden noch keine Nodes registriert.</p>
        <div class="empty-state-actions">
          <button mat-flat-button color="primary" (click)="onStartWizard()">
            <mat-icon>auto_fix_high</mat-icon>
            Setup-Assistent starten
          </button>
          <button mat-stroked-button (click)="onCreate()">
            <mat-icon>add</mat-icon>
            Manuell hinzufügen
          </button>
        </div>
      </div>
    </div>
  } @else {
    <!-- Page Header wie bei Sensoren -->
    <header class="page-header">
      <div class="header-content">
        <h1 class="page-title">Nodes</h1>
        <p class="page-subtitle">IoT-Geräte und ihre Sensorzuordnungen verwalten</p>
      </div>
    </header>

    <!-- Toolbar im O365-Style -->
    <mat-toolbar class="toolbar outlook-toolbar">
      <div class="left-actions">
        <button mat-flat-button color="primary" (click)="onCreate()">
          <mat-icon>add</mat-icon>
          Neuer Node
        </button>
        <button mat-stroked-button color="primary" (click)="onStartWizard()">
          <mat-icon>auto_fix_high</mat-icon>
          Setup-Assistent
        </button>
      </div>

      <span class="spacer"></span>

      <!-- Ergebnis-Info in Toolbar -->
      <span class="results-count">{{ filteredAndSortedNodes.length }} von {{ nodes().length }}</span>

      <!-- Sortierung -->
      <button type="button" mat-icon-button class="tbar-icon"
              [matMenuTriggerFor]="sortMenu"
              matTooltip="Sortieren">
        <mat-icon>sort</mat-icon>
      </button>
      <mat-menu #sortMenu="matMenu">
        @for (option of sortOptions; track option.value) {
          <button mat-menu-item (click)="sortField = option.value">
            <mat-icon>{{ sortField === option.value ? 'check' : '' }}</mat-icon>
            <span>{{ option.label }}</span>
          </button>
        }
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="toggleSortDirection()">
          <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          <span>{{ sortDirection === 'asc' ? 'Aufsteigend' : 'Absteigend' }}</span>
        </button>
      </mat-menu>

      <!-- Aktualisieren -->
      <button type="button" mat-icon-button class="tbar-icon"
              (click)="onRefresh()"
              matTooltip="Aktualisieren">
        <mat-icon>refresh</mat-icon>
      </button>

      <!-- Filter -->
      <button type="button" mat-icon-button class="tbar-icon"
              [class.active]="hasActiveFilters"
              (click)="toggleFilter()"
              [matTooltip]="hasActiveFilters ? 'Filter (aktiv)' : 'Filter'">
        <mat-icon>filter_list</mat-icon>
      </button>

      <!-- O365-Style Suche -->
      <div class="o365-search" [class.open]="isSearchOpen">
        <button type="button" mat-icon-button class="tbar-icon o365-search__btn"
                (click)="toggleSearch()"
                matTooltip="Suche">
          <mat-icon>search</mat-icon>
        </button>
        <div class="o365-search__field">
          <input #searchInput
                 class="o365-search__input"
                 type="text"
                 placeholder="Suche…"
                 [(ngModel)]="searchTerm"
                 (keydown.escape)="closeSearch()"
                 (blur)="onSearchBlur()" />
          @if (searchTerm.length > 0) {
            <button type="button" mat-icon-button class="tbar-icon o365-search__clear"
                    (click)="clearSearch()">
              <mat-icon>close</mat-icon>
            </button>
          }
        </div>
      </div>

      @if (hasActiveFilters || searchTerm.length >= 2) {
        <button mat-icon-button class="tbar-icon" matTooltip="Filter zurücksetzen"
                (click)="clearFilters(); searchTerm = ''">
          <mat-icon>clear</mat-icon>
        </button>
      }
    </mat-toolbar>

    @if (filteredAndSortedNodes.length === 0) {
      <myiotgrid-empty-state
        icon="search_off"
        title="Keine Nodes gefunden"
        message="Keine Nodes entsprechen den aktuellen Filterkriterien."
        actionLabel="Filter zurücksetzen"
        (actionClicked)="clearFilters(); searchTerm = ''">
      </myiotgrid-empty-state>
    } @else {
      <div class="nodes-grid">
        @for (node of filteredAndSortedNodes; track node.id) {
          <myiotgrid-node-card
            [node]="node"
            [sensorsLatest]="getSensorsLatest(node.id)"
            [isDeleting]="isDeleting() === node.id"
            (cardClick)="onCardClick($event)"
            (configureClick)="onConfigure($event)">
          </myiotgrid-node-card>
        }
      </div>
    }
  }
</div>

<!-- Filter-Drawer Template -->
<ng-template #filterDrawer>
  <div class="gt-drawer gt-filter-drawer">
    <div class="gt-drawer__header">
      <h3 class="gt-drawer__title">Nodes filtern</h3>
      <button mat-icon-button (click)="closeFilter()" aria-label="Schließen">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="gt-drawer__body">
      <div class="gt-drawer__inner">
        <div class="filter-fields">
          <!-- Status Filter -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="filterStatus">
              <mat-option value="all">Alle</mat-option>
              <mat-option value="online">Online</mat-option>
              <mat-option value="offline">Offline</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Sortierung -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Sortieren nach</mat-label>
            <mat-select [(ngModel)]="sortField">
              @for (option of sortOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <!-- Sortierrichtung -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reihenfolge</mat-label>
            <mat-select [(ngModel)]="sortDirection">
              <mat-option value="asc">Aufsteigend</mat-option>
              <mat-option value="desc">Absteigend</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </div>

    <div class="drawer-buttons">
      <button mat-button (click)="clearFilters()">
        <mat-icon>clear</mat-icon> Zurücksetzen
      </button>
      <button mat-flat-button color="primary" (click)="closeFilter()">
        <mat-icon>check</mat-icon> Anwenden
      </button>
    </div>
  </div>
</ng-template>
