<div class="node-form-container">
  @if (isLoading()) {
    <myiotgrid-loading-spinner message="Lade Node..."></myiotgrid-loading-spinner>
  } @else {
    <div class="card outlook">
      <!-- Toolbar -->
      <div class="toolbar outlook-toolbar">
        <button mat-icon-button class="tbar-icon" matTooltip="Zurück zur Liste" (click)="onBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>

        <span class="toolbar-title">Node Details</span>

        <!-- Node ID und Firmware im Header (nur wenn nicht Create-Modus) -->
        @if (!isCreateMode()) {
          <span class="header-info">
            <span class="header-label">ID:</span>
            <code class="header-value">{{ form.get('nodeId')?.value }}</code>
          </span>
          @if (form.get('firmwareVersion')?.value) {
            <span class="header-info">
              <span class="header-label">Firmware:</span>
              <span class="header-value">{{ form.get('firmwareVersion')?.value }}</span>
            </span>
          }
        }

        <span class="spacer"></span>

        <!-- Lock/Unlock Button (nur bei vorhandenen Datensätzen, nicht bei Create) -->
        @if (!isCreateMode()) {
          <button mat-icon-button class="tbar-icon"
                  [class.warn]="!isViewMode()"
                  [matTooltip]="isViewMode() ? 'Bearbeiten aktivieren' : 'Bearbeitung aktiv'"
                  (click)="toggleEditMode()">
            <mat-icon>{{ isViewMode() ? 'lock' : 'lock_open' }}</mat-icon>
          </button>
        }

        <!-- Delete Node Button (nur im Edit-Modus sichtbar) -->
        @if (isEditMode()) {
          <button mat-icon-button class="tbar-icon warn"
                  matTooltip="Node löschen"
                  [disabled]="isDeleting()"
                  (click)="deleteNode()">
            <mat-icon>{{ isDeleting() ? 'sync' : 'delete' }}</mat-icon>
          </button>
        }
      </div>

      <!-- Content -->
      <div class="content">
        <form [formGroup]="form" (ngSubmit)="onSave()">

          <!-- Basic Information -->
          <section class="form-section">
            <h3>Allgemein</h3>

            <!-- Node-ID nur im Create-Modus anzeigen -->
            @if (isCreateMode()) {
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Node-ID</mat-label>
                <input matInput formControlName="nodeId" placeholder="z.B. sensor-wohnzimmer-01">
                <mat-hint>Eindeutige ID (Buchstaben, Zahlen, Bindestriche, Unterstriche)</mat-hint>
                @if (form.get('nodeId')?.hasError('required')) {
                  <mat-error>Node-ID ist erforderlich</mat-error>
                }
                @if (form.get('nodeId')?.hasError('pattern')) {
                  <mat-error>Nur Buchstaben, Zahlen, Bindestriche und Unterstriche erlaubt</mat-error>
                }
              </mat-form-field>
            }

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Name</mat-label>
                <input matInput formControlName="name" [readonly]="isViewMode()" placeholder="z.B. Wohnzimmer Sensor">
                @if (form.get('name')?.hasError('required')) {
                  <mat-error>Name ist erforderlich</mat-error>
                }
                @if (form.get('name')?.hasError('minlength')) {
                  <mat-error>Name muss mindestens 2 Zeichen haben</mat-error>
                }
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Protokoll</mat-label>
                @if (isViewMode() || isEditMode()) {
                  <input matInput [value]="getProtocolLabel(form.get('protocol')?.value)" readonly>
                  <input type="hidden" [formControl]="$any(form.get('protocol'))">
                } @else {
                  <mat-select formControlName="protocol">
                    @for (proto of protocols; track proto.value) {
                      <mat-option [value]="proto.value">
                        <mat-icon>{{ proto.value === 'WLAN' ? 'wifi' : 'cell_tower' }}</mat-icon>
                        {{ proto.label }}
                      </mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Standort</mat-label>
                <input matInput formControlName="locationName" [readonly]="isViewMode()" placeholder="z.B. Wohnzimmer">
              </mat-form-field>

              <mat-form-field class="full"
                              [appearance]="isViewMode() ? 'fill' : 'outline'"
                              [floatLabel]="isViewMode() ? 'always' : 'auto'">
                <mat-label>Sensorart</mat-label>
                @if (isViewMode() || isEditMode()) {
                  <input matInput [value]="getNodeTypeLabel(form.get('nodeType')?.value)" readonly>
                  <input type="hidden" [formControl]="$any(form.get('nodeType'))">
                } @else {
                  <mat-select formControlName="nodeType">
                    @for (type of nodeTypes; track type.value) {
                      <mat-option [value]="type.value">{{ type.label }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>
            </div>

            <div class="simulation-toggle">
              <mat-slide-toggle formControlName="isSimulation"
                                [disabled]="isViewMode()"
                                color="primary">
                Simulationsmodus
              </mat-slide-toggle>
              <p class="toggle-hint">
                Im Simulationsmodus generiert der Node automatisch Sensor-Werte zum Testen.
              </p>
            </div>
          </section>

          <!-- Hardware Status Section (Sprint 8) -->
          @if (!isCreateMode()) {
            <mat-divider></mat-divider>

            <section class="form-section">
              <h3>Hardware-Status</h3>
              <myiotgrid-hardware-status-widget
                [nodeId]="node()!.id">
              </myiotgrid-hardware-status-widget>
            </section>
          }

          <!-- Storage Configuration Section (Sprint OS-01) -->
          @if (!isCreateMode()) {
            <mat-divider></mat-divider>

            <section class="form-section">
              <h3>Offline-Speicher</h3>

              <div class="form-row">
                <mat-form-field class="full"
                                [appearance]="isViewMode() ? 'fill' : 'outline'"
                                [floatLabel]="isViewMode() ? 'always' : 'auto'">
                  <mat-label>Speichermodus</mat-label>
                  @if (isViewMode()) {
                    <input matInput [value]="getStorageModeLabel(form.get('storageMode')?.value)" readonly>
                    <input type="hidden" [formControl]="$any(form.get('storageMode'))">
                  } @else {
                    <mat-select formControlName="storageMode">
                      @for (mode of storageModes; track mode.value) {
                        <mat-option [value]="mode.value" [matTooltip]="mode.description">
                          <mat-icon>{{ mode.value === 0 ? 'cloud_upload' : mode.value === 1 ? 'cloud_sync' : mode.value === 2 ? 'sd_card' : 'sync' }}</mat-icon>
                          {{ mode.label }}
                        </mat-option>
                      }
                    </mat-select>
                  }
                  <mat-hint>Bestimmt wie Messwerte gespeichert werden</mat-hint>
                </mat-form-field>
              </div>

              <!-- Sync Status Info -->
              @if (node(); as currentNode) {
                <div class="sync-status-card">
                  <div class="sync-status-header">
                    <mat-icon class="sync-icon" [class.syncing]="currentNode.pendingSyncCount > 0">
                      {{ currentNode.pendingSyncCount > 0 ? 'sync' : 'cloud_done' }}
                    </mat-icon>
                    <span class="sync-title">Synchronisierungsstatus</span>
                  </div>

                  <div class="sync-status-grid">
                    <div class="sync-stat">
                      <span class="stat-value" [class.warning]="currentNode.pendingSyncCount > 0">
                        {{ currentNode.pendingSyncCount }}
                      </span>
                      <span class="stat-label">Ausstehend</span>
                    </div>

                    <div class="sync-stat">
                      <span class="stat-value">
                        @if (currentNode.lastSyncAt) {
                          {{ getRelativeTime(currentNode.lastSyncAt) }}
                        } @else {
                          -
                        }
                      </span>
                      <span class="stat-label">Letzte Sync</span>
                    </div>
                  </div>

                  @if (currentNode.lastSyncError) {
                    <div class="sync-error">
                      <mat-icon>error</mat-icon>
                      <span>{{ currentNode.lastSyncError }}</span>
                    </div>
                  }
                </div>
              }
            </section>
          }

          @if (!isCreateMode()) {
            <mat-divider></mat-divider>

            <!-- Sensor Latest Readings (US-8.5.2) -->
            <section class="form-section">
              <h3>Aktuelle Messwerte</h3>

              @if (isLoadingSensorsLatest()) {
                <div class="loading-assignments">
                  <mat-icon class="spin">sync</mat-icon>
                  <span>Lade Messwerte...</span>
                </div>
              } @else if (!sensorsLatest() || sensorsLatest()!.sensors.length === 0) {
                <div class="no-assignments">
                  <mat-icon>sensors_off</mat-icon>
                  <p>Keine Messwerte vorhanden</p>
                  <span class="hint">Sobald Sensoren Daten senden, werden sie hier angezeigt.</span>
                </div>
              } @else {
                <div class="sensors-latest-grid">
                  @for (sensor of sensorsLatest()!.sensors; track sensor.assignmentId) {
                    <div class="sensor-latest-card" [class.inactive]="!sensor.isActive">
                      <div class="sensor-latest-header">
                        <div class="sensor-icon-sm" [style.background-color]="sensor.color || '#607d8b'">
                          <mat-icon>{{ sensor.icon || 'sensors' }}</mat-icon>
                        </div>
                        <div class="sensor-name-container">
                          <span class="sensor-display-name"
                                [matTooltip]="sensor.fullName"
                                matTooltipPosition="above">
                            {{ sensor.displayName }}
                          </span>
                          <span class="sensor-model">{{ sensor.sensorModel }}</span>
                        </div>
                      </div>

                      <!-- Sensor measurements (same for all sensors including GPS) -->
                      <div class="sensor-measurements">
                        @for (m of sensor.measurements; track m.measurementType) {
                          <div class="measurement-row">
                            <span class="measurement-label">{{ m.displayName }}</span>
                            <span class="measurement-value">{{ m.value | number:'1.1-1' }} {{ m.unit }}</span>
                          </div>
                        }
                      </div>

                      <div class="sensor-timestamp">
                        @if (sensor.measurements.length > 0) {
                          {{ getRelativeTime(sensor.measurements[0].timestamp) }}
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </section>

            <mat-divider></mat-divider>

            <!-- Sensor Assignments -->
            <section class="form-section">
              <div class="section-header">
                <h3>Zugeordnete Sensoren</h3>
                @if (!isViewMode()) {
                  <button mat-flat-button color="primary" type="button"
                          class="action-button"
                          (click)="openAssignmentForm()"
                          [disabled]="getUnassignedSensors().length === 0">
                    <mat-icon>add</mat-icon>
                    Sensor zuordnen
                  </button>
                }
              </div>

              @if (isLoadingAssignments()) {
                <div class="loading-assignments">
                  <mat-icon class="spin">sync</mat-icon>
                  <span>Lade Zuordnungen...</span>
                </div>
              } @else if (assignments().length === 0) {
                <div class="no-assignments">
                  <mat-icon>sensors_off</mat-icon>
                  <p>Keine Sensoren zugeordnet</p>
                  <span class="hint">Ordnen Sie diesem Node Sensoren zu, um Messwerte zu erfassen.</span>
                </div>
              } @else {
                <div class="assignments-list">
                  @for (assignment of assignments(); track assignment.id) {
                    <mat-expansion-panel class="assignment-panel" [class.inactive]="!assignment.isActive">
                      <mat-expansion-panel-header>
                        <!-- Icon -->
                        <div class="header-icon" [style.background-color]="getSensorColor(assignment.sensorCode)">
                          <mat-icon>{{ getSensorIcon(assignment.sensorCode) }}</mat-icon>
                        </div>
                        <!-- Name + Code + Chips (stacked) -->
                        <div class="header-info">
                          <span class="sensor-name">{{ assignment.alias || assignment.sensorName }}</span>
                          <span class="sensor-code">{{ assignment.sensorCode }}</span>
                          <div class="header-chips">
                            @for (cap of getSensorCapabilities(assignment.sensorCode); track cap) {
                              <span class="capability-tag">{{ cap }}</span>
                            }
                          </div>
                        </div>
                        <!-- Status Icon + Endpoint (right side, horizontal) -->
                        <div class="header-status">
                          <span class="endpoint-badge" matTooltip="Endpoint">{{ assignment.endpointId }}</span>
                          <mat-icon class="status-icon" [class.active]="assignment.isActive" [class.inactive]="!assignment.isActive"
                                    [matTooltip]="assignment.isActive ? 'Aktiv' : 'Inaktiv'">
                            {{ assignment.isActive ? 'check_circle' : 'cancel' }}
                          </mat-icon>
                        </div>
                      </mat-expansion-panel-header>

                      <div class="sensor-details">
                        <!-- Alias falls vorhanden -->
                        @if (assignment.alias) {
                          <div class="detail-row">
                            <span class="detail-label">Alias:</span>
                            <span class="detail-value">{{ assignment.alias }}</span>
                          </div>
                        }

                        <!-- Pin-Konfiguration -->
                        <h4>Konfiguration</h4>
                        <div class="config-grid">
                          <div class="config-item">
                            <span class="label">Intervall</span>
                            <span class="value">{{ assignment.effectiveConfig.intervalSeconds }}s</span>
                          </div>
                          @if (assignment.effectiveConfig.i2cAddress) {
                            <div class="config-item highlight">
                              <span class="label">I²C-Adresse</span>
                              <span class="value">{{ assignment.effectiveConfig.i2cAddress }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.sdaPin !== null && assignment.effectiveConfig.sdaPin !== undefined) {
                            <div class="config-item">
                              <span class="label">SDA Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.sdaPin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.sclPin !== null && assignment.effectiveConfig.sclPin !== undefined) {
                            <div class="config-item">
                              <span class="label">SCL Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.sclPin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.oneWirePin !== null && assignment.effectiveConfig.oneWirePin !== undefined) {
                            <div class="config-item">
                              <span class="label">OneWire Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.oneWirePin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.analogPin !== null && assignment.effectiveConfig.analogPin !== undefined) {
                            <div class="config-item">
                              <span class="label">Analog Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.analogPin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.digitalPin !== null && assignment.effectiveConfig.digitalPin !== undefined) {
                            <div class="config-item">
                              <span class="label">Digital Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.digitalPin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.triggerPin !== null && assignment.effectiveConfig.triggerPin !== undefined) {
                            <div class="config-item">
                              <span class="label">Trigger Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.triggerPin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.echoPin !== null && assignment.effectiveConfig.echoPin !== undefined) {
                            <div class="config-item">
                              <span class="label">Echo Pin</span>
                              <span class="value">GPIO {{ assignment.effectiveConfig.echoPin }}</span>
                            </div>
                          }
                          @if (assignment.effectiveConfig.baudRate !== null && assignment.effectiveConfig.baudRate !== undefined) {
                            <div class="config-item">
                              <span class="label">Baudrate</span>
                              <span class="value">{{ assignment.effectiveConfig.baudRate }}</span>
                            </div>
                          }
                          <div class="config-item">
                            <span class="label">Offset</span>
                            <span class="value">{{ assignment.effectiveConfig.offsetCorrection }}</span>
                          </div>
                          <div class="config-item">
                            <span class="label">Gain</span>
                            <span class="value">{{ assignment.effectiveConfig.gainCorrection }}</span>
                          </div>
                        </div>

                        <!-- Actions -->
                        @if (!isViewMode()) {
                          <div class="detail-actions">
                            <button mat-stroked-button type="button" (click)="toggleAssignmentActive(assignment)">
                              <mat-icon>{{ assignment.isActive ? 'pause' : 'play_arrow' }}</mat-icon>
                              {{ assignment.isActive ? 'Deaktivieren' : 'Aktivieren' }}
                            </button>
                            <button mat-stroked-button type="button" (click)="openAssignmentForm(assignment)">
                              <mat-icon>edit</mat-icon>
                              Bearbeiten
                            </button>
                            <button mat-stroked-button color="warn" type="button" (click)="deleteAssignment(assignment)">
                              <mat-icon>delete</mat-icon>
                              Entfernen
                            </button>
                          </div>
                        }
                      </div>
                    </mat-expansion-panel>
                  }
                </div>
              }

            </section>

            <mat-divider></mat-divider>

            <!-- Reading History (Generic List) -->
            <section class="form-section reading-history-section">
              <myiotgrid-generic-list
                title="Messwert-Verlauf"
                [data]="readingHistory()"
                [columns]="historyColumns"
                [totalRecords]="historyTotalRecords()"
                [loading]="isLoadingHistory()"
                [showFilter]="true"
                [showDeleteButton]="isEditMode()"
                filterTitle="Messwerte filtern"
                stateKey="node-reading-history"
                dataKey="id"
                (lazyLoad)="loadReadingsLazy($event)"
                (filterChange)="onHistoryFilterChange($event)"
                (deleteClicked)="openDeleteDrawer()">

                <!-- Filter Template -->
                <ng-template #filterTemplate let-filters>
                  <div class="filter-fields">
                    <!-- Sensor Filter -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Sensor</mat-label>
                      <mat-select [ngModel]="filters['sensorCode']"
                                  [ngModelOptions]="{standalone: true}"
                                  (ngModelChange)="filters['sensorCode'] = $event">
                        <mat-option [value]="''">Alle Sensoren</mat-option>
                        @for (sensor of getAssignedSensorNames(); track sensor.value) {
                          <mat-option [value]="sensor.value">{{ sensor.label }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    <!-- Measurement Type Filter -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Messtyp</mat-label>
                      <mat-select [ngModel]="filters['measurementType']"
                                  [ngModelOptions]="{standalone: true}"
                                  (ngModelChange)="filters['measurementType'] = $event">
                        <mat-option [value]="''">Alle Messtypen</mat-option>
                        @for (type of getMeasurementTypes(); track type.value) {
                          <mat-option [value]="type.value">{{ type.label }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>
                </ng-template>

                <!-- Custom timestamp column -->
                <ng-template myiotgridListColumnTemplate="timestamp" let-row>
                  {{ formatTimestamp(row.timestamp) }}
                </ng-template>

                <!-- Custom sensor name column -->
                <ng-template myiotgridListColumnTemplate="sensorName" let-row>
                  {{ row.sensorName || row.sensorCode || '-' }}
                </ng-template>

                <!-- Custom value column with unit -->
                <ng-template myiotgridListColumnTemplate="value" let-row>
                  <span class="reading-value">{{ row.value | number:'1.1-2' }} {{ row.unit }}</span>
                </ng-template>

              </myiotgrid-generic-list>
            </section>

            <!-- Remote Debug Section (Sprint 8) -->
            <mat-divider></mat-divider>

            <section class="form-section debug-section">
              <h3>Debug-Einstellungen</h3>

              <!-- Debug Control - inline, respects view mode -->
              <myiotgrid-node-debug-control
                #debugControl
                [nodeId]="node()!.id"
                [readonly]="isViewMode()">
              </myiotgrid-node-debug-control>
            </section>

            <mat-divider></mat-divider>

            <section class="form-section">
              <h3>Live Debug-Logs</h3>

              <!-- Live Log Viewer -->
              <myiotgrid-live-log-viewer
                [nodeId]="node()!.id">
              </myiotgrid-live-log-viewer>
            </section>
          }

        </form>
      </div>

      <!-- Footer Action Bar (nur im Edit/Create Modus sichtbar) -->
      @if (!isViewMode()) {
        <div class="form-footer">
          <!-- Rechte Seite: Abbrechen & Speichern -->
          <div class="footer-right">
            <button mat-stroked-button type="button" (click)="onCancel()">
              Abbrechen
            </button>
            <button mat-flat-button color="primary" type="button"
                    [disabled]="form.invalid || isSaving()"
                    (click)="onSave()">
              <mat-icon class="{{ isSaving() ? 'spin' : '' }}">{{ isSaving() ? 'sync' : 'check' }}</mat-icon>
              {{ isSaving() ? 'Speichern...' : (isCreateMode() ? 'Erstellen' : 'Speichern') }}
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Assignment Drawer Template -->
<ng-template #assignmentDrawer>
  <div class="gt-drawer">
    <div class="gt-drawer__header">
      <h2 class="gt-drawer__title">
        {{ editingAssignment() ? 'Zuordnung bearbeiten' : 'Sensor zuordnen' }}
      </h2>
      <button mat-icon-button (click)="closeAssignmentDrawer()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="gt-drawer__body">
      <form [formGroup]="assignmentForm" class="drawer-form">
        <!-- Sensor Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Sensor</mat-label>
          <mat-select formControlName="sensorId">
            @if (editingAssignment()) {
              <mat-option [value]="editingAssignment()!.sensorId">
                {{ editingAssignment()!.sensorName }}
              </mat-option>
            } @else {
              @for (sensor of getUnassignedSensors(); track sensor.id) {
                <mat-option [value]="sensor.id">
                  {{ sensor.name }} ({{ sensor.code }})
                </mat-option>
              }
            }
          </mat-select>
          @if (assignmentForm.get('sensorId')?.hasError('required')) {
            <mat-error>Sensor ist erforderlich</mat-error>
          }
        </mat-form-field>

        <!-- Sensor Preview (when selected) -->
        @if (getSelectedSensor(); as sensor) {
          <div class="sensor-defaults-info">
            <div class="sensor-preview">
              <div class="sensor-icon-lg" [style.background-color]="sensor.color || '#607d8b'">
                <mat-icon>{{ sensor.icon || 'sensors' }}</mat-icon>
              </div>
              <div class="sensor-details">
                <span class="sensor-name">{{ sensor.name }}</span>
                <span class="sensor-category">{{ sensor.category }} &bull; {{ sensor.manufacturer || 'Unbekannt' }}</span>
              </div>
            </div>
            <p class="info-text">
              <mat-icon>info</mat-icon>
              Standardwerte wurden übernommen.
            </p>
          </div>
        }

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Endpoint-ID</mat-label>
            <input matInput type="number" formControlName="endpointId" min="1" max="254">
            <mat-hint>Matter: 1-254</mat-hint>
            @if (assignmentForm.get('endpointId')?.hasError('required')) {
              <mat-error>Erforderlich</mat-error>
            }
            @if (assignmentForm.get('endpointId')?.hasError('min') || assignmentForm.get('endpointId')?.hasError('max')) {
              <mat-error>1-254</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Alias (optional)</mat-label>
            <input matInput formControlName="alias" placeholder="z.B. Außentemperatur">
          </mat-form-field>
        </div>

        <mat-divider></mat-divider>

        <h4 class="section-title">Pin-Konfiguration</h4>
        <p class="hint-text">Überschreibt die Sensor-Standardwerte</p>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>I2C-Adresse</mat-label>
            <input matInput formControlName="i2cAddressOverride" placeholder="0x77">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Intervall (s)</mat-label>
            <input matInput type="number" formControlName="intervalSecondsOverride" min="1">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>SDA Pin</mat-label>
            <input matInput type="number" formControlName="sdaPinOverride">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>SCL Pin</mat-label>
            <input matInput type="number" formControlName="sclPinOverride">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>OneWire Pin</mat-label>
            <input matInput type="number" formControlName="oneWirePinOverride">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Analog Pin</mat-label>
            <input matInput type="number" formControlName="analogPinOverride">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Digital Pin</mat-label>
            <input matInput type="number" formControlName="digitalPinOverride">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Trigger Pin</mat-label>
            <input matInput type="number" formControlName="triggerPinOverride">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Echo Pin</mat-label>
            <input matInput type="number" formControlName="echoPinOverride">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Baudrate</mat-label>
            <input matInput type="number" formControlName="baudRateOverride" placeholder="z.B. 115200">
            <mat-hint>UART Übertragungsrate</mat-hint>
          </mat-form-field>
        </div>
      </form>
    </div>

    <div class="drawer-buttons">
      <button mat-stroked-button type="button" class="action-button" (click)="closeAssignmentDrawer()">Abbrechen</button>
      <button mat-flat-button color="primary" type="button" class="action-button"
              (click)="saveAssignment()"
              [disabled]="assignmentForm.invalid">
        {{ editingAssignment() ? 'Speichern' : 'Zuordnen' }}
      </button>
    </div>
  </div>
</ng-template>

<!-- Delete Readings Drawer Template -->
<ng-template #deleteReadingsDrawer>
  <myiotgrid-delete-readings-drawer
    [node]="node()"
    (close)="closeDeleteDrawer()"
    (deleted)="onDeleteReadingsComplete($event)">
  </myiotgrid-delete-readings-drawer>
</ng-template>

<!-- Delete Node Drawer Template -->
<ng-template #deleteNodeDrawer>
  <div class="gt-drawer">
    <div class="gt-drawer__header">
      <h2 class="gt-drawer__title">Node löschen</h2>
      <button mat-icon-button (click)="closeDeleteNodeDrawer()" aria-label="Schließen">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="gt-drawer__body">
      @if (node(); as currentNode) {
        <div class="delete-node-content">
          <!-- Node Info -->
          <div class="node-info-card">
            <div class="node-icon">
              <mat-icon>router</mat-icon>
            </div>
            <div class="node-details">
              <span class="node-name">{{ currentNode.name }}</span>
              <span class="node-id">{{ currentNode.nodeId }}</span>
            </div>
          </div>

          <!-- Warning -->
          <div class="warning-box">
            <mat-icon>warning</mat-icon>
            <div class="warning-text">
              <strong>Achtung:</strong> Das Löschen dieses Nodes kann nicht rückgängig gemacht werden!
              Alle zugehörigen Sensorzuordnungen und Messwerte werden ebenfalls gelöscht.
            </div>
          </div>

          <!-- Confirmation Input -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Bestätigung</mat-label>
            <input matInput
                   [(ngModel)]="deleteConfirmInput"
                   placeholder="Tippe DELETE zum Bestätigen">
            <mat-hint>Tippe "DELETE" um das Löschen zu bestätigen</mat-hint>
          </mat-form-field>
        </div>
      }
    </div>

    <div class="drawer-buttons">
      <button mat-stroked-button class="action-button" (click)="closeDeleteNodeDrawer()">Abbrechen</button>
      <button mat-flat-button color="warn"
              (click)="confirmDeleteNode()"
              [disabled]="deleteConfirmInput !== 'DELETE' || isDeleting()">
        @if (isDeleting()) {
          <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
        } @else {
          <mat-icon>delete</mat-icon>
        }
        Node löschen
      </button>
    </div>
  </div>
</ng-template>
