<div class="dashboard-page" [class.mobile]="isMobile()" [class.tablet]="isTablet()" [class.desktop]="isDesktop()">
  @if (!initialLoadDone()) {
    <myiotgrid-loading-spinner message="Dashboard wird geladen..."></myiotgrid-loading-spinner>
  } @else if (totalWidgets() === 0 && !hasActiveFilters()) {
    <div class="empty-state-container">
      <div class="empty-state-content">
        <mat-icon class="empty-state-icon">sensors</mat-icon>
        <h2 class="empty-state-title">Keine Sensordaten</h2>
        <p class="empty-state-message">Es wurden noch keine Sensordaten empfangen. Stellen Sie sicher, dass Ihre Nodes konfiguriert sind und Daten senden.</p>
        <div class="empty-state-actions">
          <button mat-flat-button color="primary" (click)="navigateToNodes()">
            <mat-icon>router</mat-icon>
            Nodes verwalten
          </button>
        </div>
      </div>
    </div>
  } @else {
    <!-- Page Header wie bei Nodes -->
    <header class="page-header">
      <div class="header-content">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Sensordaten im Überblick</p>
      </div>
      <myiotgrid-connection-status></myiotgrid-connection-status>
    </header>

    <!-- Toolbar im O365-Style -->
    <mat-toolbar class="toolbar outlook-toolbar">
      <div class="left-actions">
        <button mat-stroked-button color="primary" (click)="togglePeriod()">
          <mat-icon>schedule</mat-icon>
          {{ selectedPeriodLabel() }}
        </button>
      </div>

      <span class="spacer"></span>

      <!-- Ergebnis-Info in Toolbar -->
      <span class="results-count">{{ totalWidgets() }} Widgets</span>

      <!-- Aktualisieren -->
      <button type="button" mat-icon-button class="tbar-icon"
              (click)="refresh()"
              matTooltip="Aktualisieren">
        <mat-icon>refresh</mat-icon>
      </button>

      <!-- Filter -->
      <button type="button" mat-icon-button class="tbar-icon"
              [class.active]="hasActiveFilters()"
              (click)="toggleFilter()"
              [matTooltip]="hasActiveFilters() ? 'Filter (aktiv)' : 'Filter'">
        <mat-icon>filter_list</mat-icon>
      </button>

      @if (hasActiveFilters()) {
        <button mat-icon-button class="tbar-icon" matTooltip="Filter zurücksetzen"
                (click)="clearFilters(); refresh()">
          <mat-icon>clear</mat-icon>
        </button>
      }
    </mat-toolbar>

    <!-- Alerts Banner -->
    @if (criticalAlerts().length > 0 || warningAlerts().length > 0) {
      <section class="alerts-section">
        @for (alert of criticalAlerts(); track alert.id) {
          <myiotgrid-alert-banner
            [alert]="alert"
            (acknowledge)="acknowledgeAlert($event)">
          </myiotgrid-alert-banner>
        }
        @for (alert of warningAlerts(); track alert.id) {
          <myiotgrid-alert-banner
            [alert]="alert"
            (acknowledge)="acknowledgeAlert($event)">
          </myiotgrid-alert-banner>
        }
      </section>
    }

    @if (totalWidgets() === 0 && hasActiveFilters()) {
      <myiotgrid-empty-state
        icon="search_off"
        title="Keine Widgets gefunden"
        message="Keine Sensordaten entsprechen den aktuellen Filterkriterien."
        actionLabel="Filter zurücksetzen"
        (actionClicked)="clearFilters(); refresh()">
      </myiotgrid-empty-state>
    } @else {
      <!-- Hero Locations (Full Width) -->
      @for (location of heroLocations(); track location.locationName) {
        <section class="location-section hero-section">
          <div class="widgets-grid hero-grid">
            @for (widget of location.widgets; track widget.widgetId) {
              <myiotgrid-sensor-widget
                [widget]="widget"
                [isHero]="true"
                (widgetClick)="onWidgetClick($event)">
              </myiotgrid-sensor-widget>
            }
          </div>
        </section>
      }

      <!-- Regular Locations -->
      @for (location of regularLocations(); track location.locationName) {
        <section class="location-section">
          <h2 class="location-title">
            <mat-icon class="location-icon">{{ getLocationIcon(location) }}</mat-icon>
            {{ location.locationName }}
          </h2>
          <div class="widgets-grid">
            @for (widget of location.widgets; track widget.widgetId) {
              <myiotgrid-sensor-widget
                [widget]="widget"
                [isHero]="false"
                (widgetClick)="onWidgetClick($event)">
              </myiotgrid-sensor-widget>
            }
          </div>
        </section>
      }
    }
  }
</div>

<!-- Filter-Drawer Template -->
<ng-template #filterDrawer>
  <div class="gt-drawer gt-filter-drawer">
    <div class="gt-drawer__header">
      <h3 class="gt-drawer__title">Dashboard filtern</h3>
      <button mat-icon-button (click)="closeFilter()" aria-label="Schließen">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="gt-drawer__body">
      <div class="gt-drawer__inner">
        @if (filterOptions()) {
          <!-- Standort Filter -->
          <div class="filter-section">
            <h4 class="filter-section-title">
              <mat-icon>location_on</mat-icon>
              Standorte
            </h4>
            <div class="filter-chips">
              @for (location of filterOptions()!.locations; track location) {
                <mat-chip-option
                  [selected]="isLocationSelected(location)"
                  (click)="toggleLocation(location)">
                  {{ location }}
                </mat-chip-option>
              }
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Messungsart Filter -->
          <div class="filter-section">
            <h4 class="filter-section-title">
              <mat-icon>sensors</mat-icon>
              Messungsart
            </h4>
            <div class="filter-chips">
              @for (type of filterOptions()!.measurementTypes; track type) {
                <mat-chip-option
                  [selected]="isMeasurementTypeSelected(type)"
                  (click)="toggleMeasurementType(type)">
                  <mat-icon class="chip-icon">{{ getMeasurementTypeIcon(type) }}</mat-icon>
                  {{ getMeasurementTypeLabel(type) }}
                </mat-chip-option>
              }
            </div>
          </div>
        } @else {
          <div class="filter-loading">
            <mat-icon>hourglass_empty</mat-icon>
            <span>Filteroptionen werden geladen...</span>
          </div>
        }
      </div>
    </div>

    <div class="drawer-buttons">
      <button mat-button (click)="clearFilters()">
        <mat-icon>clear</mat-icon> Zurücksetzen
      </button>
      <button mat-flat-button color="primary" (click)="applyFilters()">
        <mat-icon>check</mat-icon> Anwenden
      </button>
    </div>
  </div>
</ng-template>

<!-- Period-Drawer Template -->
<ng-template #periodDrawer>
  <div class="gt-drawer gt-period-drawer">
    <div class="gt-drawer__header">
      <h3 class="gt-drawer__title">Zeitraum wählen</h3>
      <button mat-icon-button (click)="closePeriod()" aria-label="Schließen">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="gt-drawer__body">
      <div class="gt-drawer__inner">
        <div class="period-options">
          @for (option of periodOptions; track option.value) {
            <button mat-stroked-button
                    class="period-option"
                    [class.selected]="selectedPeriod() === option.value"
                    (click)="selectPeriod(option.value)">
              <mat-icon>schedule</mat-icon>
              <span class="period-label">{{ option.label }}</span>
              <span class="period-badge">{{ option.shortLabel }}</span>
            </button>
          }
        </div>
      </div>
    </div>

    <div class="drawer-buttons">
      <button mat-flat-button color="primary" (click)="applyPeriod()">
        <mat-icon>check</mat-icon> Anwenden
      </button>
    </div>
  </div>
</ng-template>
